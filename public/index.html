<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Multiplayer Spaceship Game</title>
	<style>
		canvas {
			border: 1px solid #000;
			display: block;
			margin: 20px auto;
		}
	</style>
</head>

<body>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		const socket = io();

		const canvas = document.createElement('canvas');
		canvas.focus();
		const ctx = canvas.getContext('2d');
		document.body.appendChild(canvas);
		canvas.width = 800;
		canvas.height = 600;

		const players = {};
		const bullets = {};

		socket.on('players', (initialPlayers) => {
			Object.assign(players, initialPlayers);
			animate();
		});

		socket.on('newPlayer', (newPlayer) => {
			players[newPlayer.id] = newPlayer;
		});

		socket.on('move', (data) => {
			let player = players[data.id];
			if (player) {
				players[data.id].x = data.x;
				players[data.id].y = data.y;
				players[data.id].rotate = data.rotate;
			}
			animate();
		});

		

		socket.on('hit', (data) => {
			const player = players[data.id];
			if (player) {
				player.hp = data.hp;
			}
		});

		socket.on('playerDied', (playerId) => {
			delete players[playerId];
		});

		socket.on('playerDisconnected', (playerId) => {
			delete players[playerId];
		});

		const animate = () => {
			var img = new Image();
			img.src = "ship1.png"
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			for (let playerId in players) {
				let player = players[playerId];
				ctx.save();
				
				ctx.translate(player.x, player.y);
				ctx.rotate(player.rotate * Math.PI / 180 || 0);
				ctx.drawImage(img, -10, -10, img.width*2, img.height * 2);
				ctx.restore();
				ctx.fillStyle = '#F00';
				ctx.fillText(`${player.name} (${player.hp} HP)`, player.x, player.y - 15);
			}

			requestAnimationFrame(animate);
		};

		document.addEventListener('keydown', (event) => {
			const speed = 5;

			switch (event.key) {
				case 'ArrowUp':
					players[socket.id].y -= speed;
					players[socket.id].rotate = 270;
					socket.emit('move', { x: players[socket.id].x, y: players[socket.id].y, rotate: players[socket.id].rotate });
					break;
				case 'ArrowDown':
					players[socket.id].y += speed;
					players[socket.id].rotate = 90;
					socket.emit('move', { x: players[socket.id].x, y: players[socket.id].y, rotate: players[socket.id].rotate });
					break;
				case 'ArrowLeft':
					players[socket.id].x -= speed;
					players[socket.id].rotate = 180;
					socket.emit('move', { x: players[socket.id].x, y: players[socket.id].y, rotate: players[socket.id].rotate});
					break;
				case 'ArrowRight':
					players[socket.id].x += speed;
					players[socket.id].rotate = 0;
					socket.emit('move', { x: players[socket.id].x, y: players[socket.id].y, rotate: players[socket.id].rotate });
					break;
				case ' ':
					bullets
					socket.emit('shoot', { x: players[socket.id].x, y: players[socket.id].y, rotate: players[socket.id].rotate });
			}
		});

		const playerName = prompt('Enter your name:');
		socket.emit('join', playerName);
	</script>
</body>

</html>